generator client {
  provider        = "prisma-client"
  output          = "../src/generated/"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

model User {
  id              String             @id @default(cuid())
  supabaseId      String             @unique
  email           String             @unique
  name            String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  onboarding      OnboardingProfile?
  searchSessions  SearchSession[]
  favoriteNeighborhoods FavoriteNeighborhood[]
}

model SearchSession {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Parameters used for the analysis
  longitude       Float
  latitude        Float
  timeMinutes     Int
  mode            String

  // Neighborhood IDs found (references the shared geo cache)
  neighborhoodIds String[]

  createdAt       DateTime @default(now())

  @@index([userId, createdAt])
}

model OnboardingProfile {
  id             String   @id @default(cuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id])
  workAddress    String
  commute        Int
  priorities     String[]
  hasChildren    String
  childAgeGroups String[]
  hasPets        String
  lifestyle      String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Neighborhood {
  id        String   @id @default(cuid())
  name      String
  boundary  Json     // GeoJSON Polygon: { type: "Polygon", coordinates: [...] }
  source    String   // 'mapbox_tilequery' | 'mapbox_boundaries' | 'manual'

  // Geospatial metadata
  centerLat Float
  centerLng Float

  // Street View photo (cached indefinitely — only fetched once per neighborhood)
  photoUrl  String?

  // Caching (TTL: 7 days)
  cachedAt DateTime @default(now())

  // Relations
  pois POI[]
  favoriteNeighborhoods FavoriteNeighborhood[]

  // Indexes for performance
  @@index([centerLat, centerLng])
  @@index([cachedAt])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model POI {
  id             String       @id @default(cuid())
  neighborhoodId String
  neighborhood   Neighborhood @relation(fields: [neighborhoodId], references: [id], onDelete: Cascade)

  // POI Details
  category String // 'school' | 'park' | 'shop' | 'transit' | 'gym' | 'hospital' | 'restaurant' | 'bar'
  name     String

  // Location
  latitude  Float
  longitude Float

  // Metadata from Mapbox (flexible JSON storage)
  metadata Json? // { address, rating, amenities, etc. }
  mapboxId String? @unique

  // Caching (TTL: 24 hours)
  cachedAt DateTime @default(now())

  // Indexes for performance
  @@index([neighborhoodId, category])
  @@index([category])
  @@index([cachedAt])
  @@index([latitude, longitude])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model FavoriteNeighborhood {
  id             String       @id @default(cuid())
  userId         String
  neighborhoodId String

  // Relations
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  neighborhood   Neighborhood @relation(fields: [neighborhoodId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  // Un usuario no puede guardar el mismo barrio dos veces
  @@unique([userId, neighborhoodId])
  @@index([userId])
}

model NeighborhoodSafety {
  id                  String   @id @default(cuid())
  neighborhoodName    String   @unique // clave de búsqueda
  
  // Crime scores
  crimeScore          String   // "C+", "A-", etc.
  crimeNumeric        Float    // 0.0 - 1.0, lower = safer
  crimeDescription    String   // "Higher than average"
  
  // Crime breakdown (stored as JSON)
  crimeBreakdown      Json     // { overall, assault, theft, robbery, burglary }
  
  // Top incidents (máx 10, 1 por tipo)
  incidents           Json     // { radius_feet, date_from, date_to, count, data[] }
  
  // Cache TTL — se refresca cada 7 días
  cachedAt            DateTime @default(now())
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([neighborhoodName])
  @@index([cachedAt])
  @@map("NeighborhoodSafety")
}